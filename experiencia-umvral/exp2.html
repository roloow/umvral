<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>umVRal - Lanzamiento de proyectil</title>
    <meta name="description" content="Experiencia VR de caida libre">
    <script src="assets/javascripts/aframe.min.js"></script>
    <script src="assets/javascripts/aframe-mouse-cursor-component.min.js"></script>
		<script src="assets/javascripts/aframe-physics-system.min.js"></script>
    <script src="assets/javascripts/aframe-material.min.js"></script>
    <script src="assets/javascripts/aframe-extras.min.js"></script>
    <script src="assets/javascripts/moment-with-locales.js"></script>
    <script src="assets/javascripts/aframe-environment-component.min.js"></script>
    <script type="text/javascript">
      $ = (sel) => document.querySelector(sel)
      $$ = (sel) => document.querySelectorAll(sel)
      on = (elem, type, hand) => elem.addEventListener(type,hand)
    </script>
  </head>
	<body>

    <a-scene id="source" cursor="rayOrigin: mouse" physics="driver: local; iterations: 100;">
      <a-assets>
        <a-mixin id="image" geometry="height: 2; width: 2"></a-mixin>
      </a-assets>
      <!-- Inicio de Controles -->
      <a-entity id="camWrapper" position="0 0 3" rotation="0 +20 0">
        <a-entity id="cam" camera look-controls wasd-controls>
          <a-entity id="selector" cursor="fuse: true; fuseTimeout: 1000"
              position="0 0 -1"
              geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
              material="color: black; shader: flat">
              <a-animation begin="click" easing="ease-in" attribute="scale" dur="150" fill="forwards" from="0.1 0.1 0.1" to="1 1 1"></a-animation>
              <a-animation begin="cursor-fusing" easing="ease-in" attribute="scale" dur="1000" fill="backwards" from="1 1 1" to="0.1 0.1 0.1"></a-animation>
            </a-entity>
        </a-entity>
      </a-entity>
      <!-- Fin de Controles -->
      <!-- Environment -->
      <a-entity id="env" environment="active: true; preset: egypt; skyType: atmosphere; ground: hills; playArea: 1.2; dressingAmount: 3; fog: 0.5;"></a-entity>
      <!-- /Environment -->

      <!-- Bola de cañon -->
			<a-entity id="orange"
								dynamic-body
								geometry="primitive: sphere; radius: 0.2"
								material="color: orange; shader: flat"
								raycaster="showLine: true; objects: .blanco; useWorldCoordinates: false; origin: 0, 0, 0; direction: 0, 0, +1; far: 0.6; interval: 10"
								position="0 -4 -4">
			</a-entity>
      <!-- /Bola de cañon -->

      <!-- Tele OBJ-->
      <a-assets>
        <a-asset-item id="tele-obj" src="/objetos/tele.obj"></a-asset-item>
        <a-asset-item id="tele-mtl" src="/objetos/tele.mtl"></a-asset-item>
        <a-asset-item id="mesa-obj" src="/objetos/mesa.obj"></a-asset-item>
        <a-asset-item id="mesa-mtl" src="/objetos/mesa.mtl"></a-asset-item>
      </a-assets>
      <a-entity obj-model="obj: #tele-obj; mtl: #tele-mtl" scale="0.030 0.03 0.03" position="-0.7 1.5 7.5" rotation="270 0 180"></a-entity>
      <a-entity obj-model="obj: #mesa-obj; mtl: #mesa-mtl" scale="0.030 0.03 0.03" position="-0.7 0 7.5" rotation="270 0 180"></a-entity>
      <!-- /Tele OBJ-->

      <!-- Video -->
      <a-assets>
          <video id="tutorial" src="video/prueba.mp4"></video>
      </a-assets>
      <a-video src="#tutorial" width="1.6" height="0.9" position="-0.7 2.7 7.4" material="" geometry="" rotation="0 180 0" scale="1.6 1.55 1.56"></a-video>
      <a-button id="playTV" position="-0.15 2.67 7.37" rotation="0 180 0" name="play"  value="Tutorial"></a-button>
      <!-- /Video-->




      <!-- Cañon -->
      <a-cylinder id="cannon" class="cannon" position="0 0 -3.2" radius="0.4" height="5" rotation="-60 0 0" angle="30" color="gray"></a-cylinder>
      <a-box position="3 0.3 -3" height="0.8" width="4" rotation="0 -20 0" color="brown"></a-box>

        <a-button id="v1" position="1 0.3 -3" rotation="0 -20 0" name="velocidad1"  value="1"></a-button>
        <a-button id="v2" position="2 0.3 -2.5" rotation="0 -20 0" name="velocidad2"  value="2"></a-button>
        <a-button id="v3" position="3 0.3 -2" rotation="0 -20 0" name="velocidad3"  value="3"></a-button>
      <!-- /Cañon -->

      <!-- rack -->
      <a-assets>
        <a-asset-item id="rack-obj" src="/objetos/rack.obj"></a-asset-item>
        <a-asset-item id="rack-mtl" src="/objetos/rack.mtl"></a-asset-item>
      </a-assets>
      <a-entity obj-model="obj: #rack-obj; mtl: #rack-mtl" scale="0.01 0.01 0.01" rotation="-90 -45 0" position="7 0 6"></a-entity>
      <!-- /rack -->

      <!-- Cañones a seleccionar -->
      <a-assets>
        <a-asset-item id="cannon1-obj" src="/objetos/canonobsidiana.obj"></a-asset-item>
        <a-asset-item id="cannon1-mtl" src="/objetos/canonobsidiana.mtl"></a-asset-item>
        <a-asset-item id="cannon2-obj" src="/objetos/canonmadera.obj"></a-asset-item>
        <a-asset-item id="cannon2-mtl" src="/objetos/canonmadera.mtl"></a-asset-item>
        <a-asset-item id="cannon3-obj" src="/objetos/canonjade.obj"></a-asset-item>
        <a-asset-item id="cannon3-mtl" src="/objetos/canonjade.mtl"></a-asset-item>
      </a-assets>
      <a-entity id="cannon3" obj-model="obj: #cannon3-obj; mtl: #cannon3-mtl" scale="0.0008 0.0008 0.0008" rotation="90 -5 0" position="7 1.2 6"></a-entity>
      <a-entity id="cannon2" obj-model="obj: #cannon2-obj; mtl: #cannon2-mtl" scale="0.0008 0.0008 0.0008" rotation="90 -5 0" position="7.25 1.9 6"></a-entity>
      <a-entity id="cannon1" obj-model="obj: #cannon1-obj; mtl: #cannon1-mtl" scale="0.0008 0.0008 0.0008" rotation="90 -5 0" position="7.5 2.6 6"></a-entity>
      <!-- /Cañones a seleccionar -->

      <!-- Plano   -->
      <a-plane id="plano" class="blanco" static-body position="0 -0.01 -4" rotation="-90 0 0" width="100" height="100" color="#7BC8A4" shadow></a-plane>
      <!-- /Plano -->

      <!-- Blanco -->
				<!--a-cylinder id="target-1" class="blanco" src="assets/exp2/targettexture.jpg" position="0 0 0 radius="0.8" height="0.1" rotation="90 20 0"
				></a-cylinder-->
				<a-cylinder id="target0" class="blanco" src="assets/exp2/targettexture.jpg" position="0 0 0" radius="0.8" height="0.1" rotation="90 0 0"
				></a-cylinder>
				<!--a-cylinder id="target1" class="blanco" src="assets/exp2/targettexture.jpg" position="0 0 0" radius="0.8" height="0.1" rotation="90 -20 0"
				></a-cylinder-->
        <a-text id="targetPosition" position="0 5 -24" ></a-text>
      <!-- /Blanco -->


      <!-- Pizarra OBJ-->
      <a-assets>
        <a-asset-item id="piz-obj" src="/objetos/pizarra.obj"></a-asset-item>
        <a-asset-item id="piz-mtl" src="/objetos/pizarra.mtl"></a-asset-item>
      </a-assets>
      <a-entity obj-model="obj: #piz-obj; mtl: #piz-mtl" scale="0.015 0.015 0.015" position="-5.05 0 3" rotation="-90 90 0"></a-entity>

      <!-- /Pizarra OBJ-->

      <!-- Pizarra >
      <a-plane id="pizarra" width="4" height= "3" rotation="0 90 0" position="-5 3 3" color= "white" ></a-plane-->
      <a-text id="textoPizarraEnBlanco"
              value=" x(t)= vt + x0 \n "
              width="4"
              height = "3"
              position="-5 3.5 4.95"
              rotation="0 90 0"
              color="white"
              text="anchor: align; align: left; baseline: top"
              >
      </a-text>

      <a-text id="textoPizarra30grados"
            value=" x(t)= vt(set(30)) + x0 \n y(t)= -g(t^2)/2 + vt(cos(30)) + y0 \n sen(30)= \n cos(30)= "
            height = "3"
            width="4"
            position="-5 3.5 4.95"
            rotation="0 90 0"
            color="white"
            visible='false'
            text="anchor: align; align: left; baseline: top"
            >
      </a-text>

      <a-text id="textoPizarra45grados"
            value=" x(t)= vt(set(45)) + x0 \n y(t)= -g(t^2)/2 + vt(cos(45)) + y0 \n sen(45)= \n cos(45)= "
            height = "3"
            width="4"
            position="-5 3.5 4.95"
            rotation="0 90 0"
            color="white"
            visible='false'
            text="anchor: align; align: left; baseline: top"
            >
      </a-text>

      <a-text id="textoPizarra60grados"
            value=" x(t)= vt(set(60)) + x0 \n y(t)= -g(t^2)/2 + vt(cos(60)) + y0 \n sen(60)= \n cos(60)= "
            height = "3"
            width="4"
            position="-5 3.5 4.95"
            rotation="0 90 0"
            color="white"
            visible='false'
            text="anchor: align; align: left; baseline: top"
            >
      </a-text>


      <a-button id="alfa1" position="-5 1.1 4.5" rotation="0 90 0" button="name: 30grados; value: 30°; color: #f8faff; buttonColor: #858787"></a-button>
      <a-button id="alfa3" position="-5 1.1 2.5" rotation="0 90 0" button="name: 60grados; value: 60°; color: #f8faff; buttonColor: #858787"></a-button>
      <a-button id="alfa2" position="-5 1.1 3.5" rotation="0 90 0" button="name: 45grados; value: 45°; color: #f8faff; buttonColor: #858787"></a-button>
      <!-- /Pizarra -->



    </a-scene>
	</body>
  <script>
    /*************************
     				VARIABLES
    *************************/

		// Valores posibles de seleccion
		//var velocidades = [18, 12, 6] //velocidades iniciales disponibles
		var velocidades = [18] //velocidades iniciales disponibles
		var angulos = [30,45,60] //angulos disponibles
		var angulos_h = [-1,0,1] //angulos disponibles
		var respuestas = []
		var cant_respuestas = 3

    // para click en cannon
    var v_o = 18;
    var cannon_angle = 0; // angulo horizontal
    var gamma = 30; // angulo vertical

    var gravity = 9.8;
    var launching_ball = false; //true: bola es lanzada

    var video = document.querySelector("#tutorial");
    var playTV = document.querySelector("#playTV");

    var alfa1= document.querySelector("#alfa1");
    var alfa2= document.querySelector("#alfa2");
    var alfa3= document.querySelector("#alfa3");
    var textoPizarraEnBlanco = document.querySelector('#textoPizarraEnBlanco');
    var textoPizarra30grados = document.querySelector("#textoPizarra30grados");
    var textoPizarra45grados = document.querySelector("#textoPizarra45grados");
    var textoPizarra60grados = document.querySelector("#textoPizarra60grados");

    var offset_z = 4 //offset de calculos de targets respecto a punto de lanzamiento
    var offset_y = 0
		//var target_1 = document.querySelector('#target-1');
		var target0 = document.querySelector('#target0');
		//var target1 = document.querySelector('#target1');
    var orange = document.querySelector('#orange');
    var cannon_ = document.querySelector(".cannon");
		var cannon_obj = document.querySelector('#cannon');

		//Botones para posicion horizontal de cañon
		var angle_1 = document.querySelector('#v1');
		var angle0 = document.querySelector('#v2');
		var angle1 = document.querySelector('#v3');

		//Generar las respuestas de la experiencia
		generateAnswers();
		console.log(respuestas)
		nextTarget();


    /*************************
			 FUNCIONES DE EVENTOS 
    **************************/

    alfa1.addEventListener('click', function(){
      textoPizarraEnBlanco.setAttribute('visible','false');
      textoPizarra45grados.setAttribute('visible','false');
      textoPizarra60grados.setAttribute('visible','false');
      textoPizarra30grados.setAttribute('visible','true');
      gamma=30;
      // cambio en angulo del cañon
      cannon_obj.object3D.rotation.x = -degToRad(90-gamma);
      cannon_obj.object3D.position.set = (0,0,-3.2);
      // cambio de angulo bala


    });
    alfa2.addEventListener('click', function(){
      textoPizarraEnBlanco.setAttribute('visible','false');
      textoPizarra45grados.setAttribute('visible','true');
      textoPizarra60grados.setAttribute('visible','false');
      textoPizarra30grados.setAttribute('visible','false');
      gamma=45;
      // cambio en angulo del cañon
      cannon_obj.object3D.rotation.x = -degToRad(90-gamma);
      cannon_obj.object3D.position.set = (0,0,-3.2);
      // cambio de angulo bala

    });
    alfa3.addEventListener('click', function(){
      textoPizarraEnBlanco.setAttribute('visible','false');
      textoPizarra45grados.setAttribute('visible','false');
      textoPizarra60grados.setAttribute('visible','true');
      textoPizarra30grados.setAttribute('visible','false');
      gamma=60;
      // cambio en angulo del cañon
      cannon_obj.object3D.rotation.x = -degToRad(90-gamma);
      cannon_obj.object3D.position.set = (0,0,-3.2);
      // cambio de angulo bala

    });

    playTV.addEventListener('click',function(){
      video.play();
      playTV.setAttribute('visible','false');
    });

    video.addEventListener('ended',myHandler,false);
    function myHandler(e) {
        playTV.setAttribute('visible','true');
    }


    /* Lanzamiento de Bala */
    cannon_.addEventListener('click', function(){
			if (launching_ball === false || orange.body.position < -1 || orange.body.position.y < 0.8) {
        launching_ball = true;
				//Reset de velocidades de la Bala
        orange.body.angularVelocity.set(0,0,0);
        orange.body.quaternion.set(0,0,0,1);
        orange.body.position.set(0, 1.5, -4.5);
        velocity = getVelocity(v_o , gamma, cannon_angle)
        orange.body.velocity.set(velocity[0], velocity[1], -velocity[2]);
      }
    });


		/* Evento de colision de Raycaster de Bala con Target/Plano */
    /* Funcion que se lanza, cuando la bala tiene una colision con un
      target o el suelo, para poder reiniciar el disparo
      * Variables Offset: sirven cuando el cañon tinee que moverse de posicion, ya
      que se asume que el cañon debiese estar en 0.0
      */
		orange.addEventListener('raycaster-intersection', function (e) {
      launching_ball = false;
      if (e.detail.els[0].getAttribute('id') === 'plano'){
        orange.body.velocity.set(0, 0, 0);
        orange.body.position.set(0, -4, -4.5);
      }
			else if (e.detail.els[0].getAttribute('id') === 'target0'){
				orange.body.velocity.set(0, 0, 0);
				orange.body.position.set(0, -4, -4.5);
				nextTarget();
			}
			// OJO: Este if, fija la respuesta para cierto angulo. Si el target tiene dos respuestas,
			// entonces no funcionaria, y habria que hacer colisiones con dos versiones
			/*
      if (parseInt(e.detail.els[0].getAttribute('angle')) == gamma){
      }
			*/
		});


		/* Click, para cambiar el cañon de posicion horizontal */
    angle_1.addEventListener('click', function(){
			changeCanonPosition(-1);
    });
    angle0.addEventListener('click', function(){
			changeCanonPosition(0);
    });
    angle1.addEventListener('click', function(){
			changeCanonPosition(1);
    });

    /**************************
			 FUNCIONES DE SOPORTE
    **************************/

		// Crear posicion no random para los targets
		/*
			* angle : Angulo horizontal
			* v_o : Velocidad inicial del arreglo
			* gamma : Angulo vertical del cañon
			*/
		function targetPos(angle, v_o, gamma){
			if (angle === -1) {
				position = getTargetPosition(v_o, gamma, -1) //Obtener posicion random para el target
				target0.object3D.position.set(position[0],position[1]+offset_y,-(position[2]+offset_z));
        target0.object3D.rotation.y = degToRad(20);
			}
			else if (angle === 1){
				position = getTargetPosition(v_o, gamma, 1) //Obtener posicion random para el target
				target0.object3D.position.set(position[0],position[1]+offset_y,-(position[2]+offset_z));
        target0.object3D.rotation.y = degToRad(-20);
			}
			else {
				position = getTargetPosition(v_o, gamma, 0) //Obtener posicion random para el target
				target0.object3D.position.set(0,position[1]+offset_y,-(position[2]+offset_z));
        target0.object3D.rotation.y = degToRad(0);
			}
		}


		/* generateAnswers*/
		/* Genera las respuestas al inicio de la experiencia, que el estudiante 
			tiene que responder para poder completar la experiencia
			- formato respuesta: [velocidad, angulo_vert, angulo_hor]*/
		function generateAnswers(){
			for(i=0; i<cant_respuestas; i++){
				var aux = {};
				aux.vel = velocidades[getRandNumber(velocidades.length)];
				aux.vertangl = angulos[getRandNumber(angulos.length)];
				aux.horangl = angulos_h[getRandNumber(angulos_h.length)];
				respuestas.push(aux);
			}
		}

		/* nextTarget */
		/* Saca de la pila de targets a ser apuntados el próximo target */
		function nextTarget(){
			if(respuestas.length >= 1){
				let t = respuestas.pop();
				console.log(t)
				targetPos(t.horangl, t.vel, t.vertangl);
			}
			else {
				target0.setAttribute("visible",false)
				console.log("Experiencia Finalizada!")
			}
			return true;
		}

		/* getRandNumber*/
		/* Devuelve un numero random, de 0 a limit */
		function getRandNumber(limit){
			return Math.floor(Math.random()*limit);
		}

		/* Obtener velocidad de la Bala, en el lanzamiento */
    function getVelocity(v_o, theta, angulo) {
      theta = degToRad(theta)
      v_x = 0
      v_z = v_o * Math.cos(theta)
      if (angulo === +1){
        v_x = v_z * Math.cos(70)
        v_z = v_z * Math.sin(70)
      }
      else if (angulo === -1){
        v_x = -v_z * Math.cos(70)
        v_z = v_z * Math.sin(70)
      }
      v_y = v_o * Math.sin(theta)
      return [v_x, v_y, v_z]
    }

    /* Obtener posición próxima de un Target */
		/*
    Obtiene posicion random de un target
    input:
    v_o: Veloicdad inicial correcta
    theta: Angulo correcto de respuesta
		grad: Grado Horizontal
    */
    function getTargetPosition(v_o, theta, grad) {
			theta = degToRad(theta)	
			v_y = v_o * Math.sin(theta);
			v_x = v_o * Math.cos(theta);
			time_max = (2 * v_y)/gravity;
			interval = (time_max - 0.3 )/ 7;
			//Se añade un tiempo pequeño, para que target no aparesca en el mismo lugar
			//que el cañon
			rand = Math.floor(Math.random()*8)
			time = (rand*interval)+0.3;
			p_y = (v_y * time) - 0.5*gravity*Math.pow(time, 2);
			p_x = 0;
			p_z = v_x * time;

			if (grad === -1){
				p_x = (-p_z * Math.cos(70));
				p_z = (p_z * Math.sin(70));
			}
			else if (grad === 1){
				p_x = (p_z * Math.cos(70));
				p_z = (p_z * Math.sin(70));
			}
			return [p_x, p_y+1, p_z];
    }

		/* Cambiar Grados por Radianes. Requerida por THREE.JS */
    function degToRad(deg){
      return deg * Math.PI / 180;
    }

    grad20 = degToRad(20);
    function changeCanonPosition(angle) {
        if (angle === -1){
          cannon_obj.object3D.rotation.y = grad20;
					cannon_angle = -1; 
        }
        else if (angle === 1){
          cannon_obj.object3D.rotation.y = -grad20;
					cannon_angle = 1;
        }
        else{
          cannon_obj.object3D.rotation.y = 0;
					cannon_angle = 0;
        }
    }
  </script>
</html>
