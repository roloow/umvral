<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>umVRal - Lanzamiento de proyectil</title>
    <meta name="description" content="Experiencia VR de caida libre">
    <script src="assets/javascripts/aframe.min.js"></script>
    <script src="assets/javascripts/aframe-mouse-cursor-component.min.js"></script>
		<script src="assets/javascripts/aframe-physics-system.min.js"></script>
    <script src="assets/javascripts/aframe-material.min.js"></script>
    <script src="assets/javascripts/aframe-extras.min.js"></script>
    <script src="assets/javascripts/moment-with-locales.js"></script>
    <script src="assets/javascripts/aframe-environment-component.min.js"></script>
		<script src="assets/javascripts/aframe-animation-component.min.js"></script> 
		<script src="assets/javascripts/aframe-slice9-component.min.js"></script>
    <script type="text/javascript">
      $ = (sel) => document.querySelector(sel)
      $$ = (sel) => document.querySelectorAll(sel)
      on = (elem, type, hand) => elem.addEventListener(type,hand)
    </script>
  </head>
	<body>

    <a-scene id="source" cursor="rayOrigin: mouse" physics="driver: local; iterations: 100;">
      <a-assets>
        <a-mixin id="image" geometry="height: 2; width: 2"></a-mixin>
        <a-asset-item id="cannon1-obj" src="/objetos/canonobsidiana.obj"></a-asset-item>
        <a-asset-item id="cannon1-mtl" src="/objetos/canonobsidiana.mtl"></a-asset-item>
        <a-asset-item id="repo-obj" src="/objetos/reposera.obj"></a-asset-item>
        <a-asset-item id="repo-mtl" src="/objetos/reposera.mtl"></a-asset-item>
        <a-asset-item id="cannon2-obj" src="/objetos/canonmadera.obj"></a-asset-item>
        <a-asset-item id="cannon2-mtl" src="/objetos/canonmadera.mtl"></a-asset-item>
        <a-asset-item id="cannon3-obj" src="/objetos/canonjade.obj"></a-asset-item>
        <a-asset-item id="cannon3-mtl" src="/objetos/canonjade.mtl"></a-asset-item>
        <a-asset-item id="panel-obj" src="/objetos/panel.obj"></a-asset-item>
        <a-asset-item id="panel-mtl" src="/objetos/panel.mtl"></a-asset-item>
        <a-asset-item id="boton-obj" src="/objetos/botonrojo.obj"></a-asset-item>
        <a-asset-item id="boton-mtl" src="/objetos/botonrojo.mtl"></a-asset-item>
        <a-asset-item id="tele-obj" src="/objetos/tele.obj"></a-asset-item>
        <a-asset-item id="tele-mtl" src="/objetos/tele.mtl"></a-asset-item>
        <a-asset-item id="mesa-obj" src="/objetos/mesa.obj"></a-asset-item>
        <a-asset-item id="mesa-mtl" src="/objetos/mesa.mtl"></a-asset-item>
        <video id="tutorial" src="video/Tutorial.mp4"></video>
        <a-asset-item id="rack-obj" src="/objetos/rack.obj"></a-asset-item>
        <a-asset-item id="rack-mtl" src="/objetos/rack.mtl"></a-asset-item>
        <a-asset-item id="piz-obj" src="/objetos/pizarra.obj"></a-asset-item>
        <a-asset-item id="piz-mtl" src="/objetos/pizarra.mtl"></a-asset-item>
      </a-assets>
      <!-- Inicio de Controles -->
			<a-button id="btn_tooltips" color="blue" position="-2 1 -3" value="Tutorial"></a-button>
      <a-entity id="camWrapper" position="0 0 3" rotation="0 +20 0">
        <a-entity id="cam" camera look-controls wasd-controls>
					<a-entity id="tooltips">
						<a-entity id="hint_rectangle" slice9="width: 2.3; height: 0.6; left: 20; right: 43; top: 20; bottom: 43; src: assets/images/tooltip.png; transparent: true; opacity: 0" position="0.1 1 -3"></a-entity>
						<a-entity material="opacity: 0;" id="hints" text="value: Ook, pongamonos serios. Veamos si el test de los mensajes funciona bien ; color: white; width: 0.8; wrap-pixels: 800; opacity: 0, transparent: true" position="0.06 0.41 -1.2" visible="false"></a-entity>
					</a-entity>
          <a-entity id="selector" cursor="fuse: true; fuseTimeout: 600"
              position="0 0 -1"
              geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
              material="color: black; shader: flat">
              <a-animation begin="click" easing="ease-in" attribute="scale" dur="150" fill="forwards" from="0.1 0.1 0.1" to="1 1 1"></a-animation>
              <a-animation begin="cursor-fusing" easing="ease-in" attribute="scale" dur="1000" fill="backwards" from="1 1 1" to="0.1 0.1 0.1"></a-animation>
            </a-entity>
        </a-entity>
      </a-entity>
      <!-- Fin de Controles -->
      <!-- Environment -->
      <a-entity id="env" environment="active: true; preset: egypt; skyType: atmosphere; ground: hills; playArea: 1.2 ;dressing:stones; dressingAmount: 20; fog: 0.5;lightPosition:0 4.65 -1;"></a-entity>
      <!--a-entity id="env" environment="active:true;preset:egypt;skyType:atmosphere;playArea:1.2;dressingAmount:20;fog:0.5;seed:26;skyColor:#1b7660;horizonColor:#e4b676;lightPosition:0 4.65 -1;groundYScale:5;groundTexture:walkernoise;groundColor:#a8785a;groundColor2:#875e47;dressing:stones;dressingColor:#7c5c45;dressingScale:4;dressingVariance:20 20 20;grid:spots;gridColor:#e4b676;shadowSize:20" visible=""><a-entity class="environment" position="0 50 0" light="type:hemisphere;color:#CEE4F0;intensity:0.5888241556472172;groundColor:#a8785a" visible=""></a-entity><a-entity class="environment" position="0 4.65 -1" light="intensity:0.5888241556472172;shadowCameraLeft:-20;shadowCameraBottom:-20;shadowCameraRight:20;shadowCameraTop:20" visible=""></a-entity><a-entity rotation="-90 0 0" class="environmentGround environment" visible="" scale="1 1 5" shadow="cast:false;receive:false"></a-entity><a-entity class="environmentDressing environment" visible=""></a-entity><a-sky radius="200" geometry="" theta-length="110" class="environment" material="shader:skyshader;sunPosition:0 0.9776483112944344 -0.21024694866546975" visible=""></a-sky><a-entity id="stars"></a-entity></a-entity>
      <!-- /Environment -->

      <!-- Bola de ca単on -->
			<a-entity id="orange"
								dynamic-body
								geometry="primitive: sphere; radius: 0.2"
								material="color: orange; shader: flat"
								raycaster="showLine: false; objects: .blanco; useWorldCoordinates: false; origin: 0, 0, 0; direction: 0, 0, +1; far: 0.8; interval: 10"
								position="0 -4 -4">
			</a-entity>
      <!-- /Bola de ca単on -->

      <!-- Tele OBJ-->
      <a-entity obj-model="obj: #tele-obj; mtl: #tele-mtl" scale="0.030 0.03 0.03" position="-0.7 1.5 7.5" rotation="270 0 180"></a-entity>
      <a-entity obj-model="obj: #mesa-obj; mtl: #mesa-mtl" scale="0.030 0.03 0.03" position="-0.7 0 7.5" rotation="270 0 180"></a-entity>
      <!-- /Tele OBJ-->

      <!-- Video -->
      <a-video src="#tutorial" width="1.6" height="0.9" position="-0.7 2.7 7.4" material="" geometry="" rotation="0 180 0" scale="1.6 1.55 1.56"></a-video>
      <a-button id="playTV" position="-0.15 2.67 7.37" rotation="0 180 0" name="play"  value="Tutorial"></a-button>
      <!-- /Video-->


      <!--a-entity id="shoot" class="cannon" obj-model="obj: #boton-obj; mtl: #boton-mtl" scale="0.00005 0.00005 0.00005" rotation="0 -20 0" position="1.7 1 1.1"></a-entity-->
      <a-entity id="shoot" class="cannon" obj-model="obj:/objetos/botonrojo.obj;mtl:/objetos/botonrojo.mtl" scale="0.00005 0.00005 0.00005" rotation="0 -20 0" position="0.985 1.0 1.054"></a-entity>
      <!--a-entity  obj-model="obj: #panel-obj; mtl: #panel-mtl" scale="0.01 0.01 0.01" rotation="-90 -20 0" position="1.5 0 1"></a-entity-->
      <a-entity obj-model="obj:/objetos/panel.obj;mtl:/objetos/panel.mtl" scale="0.01 0.01 0.01" rotation="-90 -20 0" position="1 -0.2 1"></a-entity>
      <!-- Ca単on -->
			<a-entity id="cannons">
				<a-entity id="cannonL1" class="cannon" obj-model="obj: #cannon1-obj; mtl: #cannon1-mtl" scale="0.0008 0.0008 0.0008" rotation="130 0 0" position="0.368 1.288 -3.966"></a-entity>
				<a-entity id="cannonL2" class="cannon" visible="false" obj-model="obj: #cannon2-obj; mtl: #cannon2-mtl" scale="0.0008 0.0008 0.0008" rotation="130 0 0" position="0.368 1.288 -3.966"></a-entity>
				<a-entity id="cannonL3" class="cannon" visible="false" obj-model="obj: #cannon3-obj; mtl: #cannon3-mtl" scale="0.0008 0.0008 0.0008" rotation="130 0 0" position="0.368 1.288 -3.966"></a-entity>
				<a-entity id="repo" obj-model="obj: #repo-obj; mtl: #repo-mtl" scale="0.00001 0.00001 0.00001" rotation="-90 180 0" position="0 0 -3"></a-entity>
			</a-entity>

      <a-button id="start" scale="0.5 0.6 0.6" button-color="red" position="-0.30 1.8 0.8" rotation="0 0 0" name="velocidad1" value="EMPEZAR" button=""><a-sound key="aframeButtonClickSound" sfx="true" src="#aframeButtonClick" sound="" position="0 2 5"></a-sound><a-sound key="aframeButtonClickDisabledSound" sfx="true" src="#aframeButtonClickDisabled" sound="" position="0 2 5"></a-sound><a-entity position="0 0 0.01"><a-image height="0.44999999999999996" geometry="" src="#aframeButtonShadow" material="" width="1.3820372670807453" position="0.5906142167011732 0 0"></a-image><a-rounded height="0.36" rounded="" radius="0.03" position="0 -0.18 0.01" color="red" width="1.1812284334023464"><a-entity text="align:center;wrapCount:10;width:1;value:EMPEZAR" position="0.5906142167011732 0.18 0.02"></a-entity></a-rounded></a-entity></a-button>
      <a-button id="v1" scale="0.2 0.3 0.3" position="0.716 1.20 0.954" rotation="0 -20 0" name="velocidad1"  value="\"></a-button>
      <a-button id="v2" scale="0.2 0.3 0.3" position="0.918 1.200 1.022" rotation="0 -20 0" name="velocidad2"  value="|"></a-button>
      <a-button id="v3" scale="0.2 0.3 0.3" position="1.120 1.200 1.09" rotation="0 -20 0" name="velocidad3"  value="/"></a-button>

      <a-button id="h1" scale="0.2 0.3 0.3" position="0.716 0.80 0.954" rotation="0 -20 0" name="velocidad1"  value="30"></a-button>
      <a-button id="h2" scale="0.2 0.3 0.3" position="0.918 0.80 1.022" rotation="0 -20 0" name="velocidad2"  value="45"></a-button>
      <a-button id="h3" scale="0.2 0.3 0.3" position="1.120 0.80 1.09" rotation="0 -20 0" name="velocidad3"  value="60"></a-button>



      <!-- /Ca単on -->

      <!-- rack -->
      <a-entity obj-model="obj: #rack-obj; mtl: #rack-mtl" scale="0.01 0.01 0.01" rotation="-90 -45 0" position="7 0 6"></a-entity>
      <!-- /rack -->

      <!-- Ca単ones a seleccionar -->
      <a-entity id="cannon3" obj-model="obj: #cannon3-obj; mtl: #cannon3-mtl" scale="0.0008 0.0008 0.0008" rotation="90 -5 0" position="7 1.2 6"></a-entity>
      <a-entity id="cannon2" obj-model="obj: #cannon2-obj; mtl: #cannon2-mtl" scale="0.0008 0.0008 0.0008" rotation="90 -5 0" position="7.25 1.9 6"></a-entity>
      <a-entity id="cannon1" obj-model="obj: #cannon1-obj; mtl: #cannon1-mtl" scale="0.0008 0.0008 0.0008" rotation="90 -5 0" position="7.5 2.6 6"></a-entity>
      <!-- /Ca単ones a seleccionar -->

      <!-- Plano   -->
      <a-plane id="plano" class="blanco" static-body position="0 -0.01 -4" rotation="-90 0 0" width="300" height="300" color="#7BC8A4" shadow></a-plane>
      <!-- /Plano -->

      <!-- Blanco -->
				<!--a-cylinder id="target-1" class="blanco" src="assets/exp2/targettexture.jpg" position="0 0 0 radius="0.8" height="0.1" rotation="90 20 0"
				></a-cylinder-->
				<a-cylinder id="target0" visible="false" class="blanco" src="assets/exp2/targettexture.jpg" position="0 0 0" radius="0.8" height="0.1" rotation="90 0 0"
				></a-cylinder>
				<!--a-cylinder id="target1" class="blanco" src="assets/exp2/targettexture.jpg" position="0 0 0" radius="0.8" height="0.1" rotation="90 -20 0"
				></a-cylinder-->
        <a-text id="targetPosition" position="0 5 -24" ></a-text>
      <!-- /Blanco -->


      <!-- Pizarra OBJ-->
      <a-entity obj-model="obj: #piz-obj; mtl: #piz-mtl" scale="0.015 0.015 0.015" position="-5.05 0 3" rotation="-90 90 0"></a-entity>

      <!-- /Pizarra OBJ-->

      <!-- Pizarra >
      <a-plane id="pizarra" width="4" height= "3" rotation="0 90 0" position="-5 3 3" color= "white" ></a-plane-->
      <a-text id="textoPizarraEnBlanco"
              value="Ecuaciones que describen el movimiento: \n x(t)= Vxt + x0 \n y(t)=-g(t^2)/2+Vyt \n Vx: velocidad en eje x \n Vy: velocidad en eje y"
              width="4"
              height = "3"
              position="-5 3.5 4.95"
              rotation="0 90 0"
              color="white"
              text="anchor: align; align: left; baseline: top"
              >
      </a-text>

      <a-text id="textoPizarra30grados"
            value="Ecuaciones que describen el movimiento: \n x(t)= vt(set(30)) + x0 \n y(t)= -9.81(t^2)/2 + vt(cos(30)) + y0 \n sen(30)=0.5 \n cos(30)=0.866 "
            height = "3"
            width="4"
            position="-5 3.5 4.95"
            rotation="0 90 0"
            color="white"
            visible='false'
            text="anchor: align; align: left; baseline: top"
            >
      </a-text>


      <a-text id="coordenadastarget"
            value="coordenadas target "
            height = "3"
            width="4"
            position="-5 2.5 4.95"
            rotation="0 90 0"
            color="white"

            text="anchor: align; align: left; baseline: top"
            >
      </a-text>

      <a-text id="indicadorcoordenadas"
            value=""
            height = "7"
            width="7"
            position="0 5 -6"
            rotation="0 0 0"
            color="black"
            visible="false"
            text="anchor: align; align: center; baseline: top"
            >
      </a-text>

      <a-text id="textoPizarra45grados"
            value="Ecuaciones que describen el movimiento: \n x(t)= vt(set(45)) + x0 \n y(t)= -9.81(t^2)/2 + vt(cos(45)) + y0 \n sen(45)= 0.707 \n cos(45)= 0.707"
            height = "3"
            width="4"
            position="-5 3.5 4.95"
            rotation="0 90 0"
            color="white"
            visible='false'
            text="anchor: align; align: left; baseline: top"
            >
      </a-text>

      <a-text id="textoPizarra60grados"
            value="Ecuaciones que describen el movimiento: \n x(t)= vt(set(60)) + x0 \n y(t)= -9.81(t^2)/2 + vt(cos(60)) + y0 \n sen(60)=0.866 \n cos(60)=0.5 "
            height = "3"
            width="4"
            position="-5 3.5 4.95"
            rotation="0 90 0"
            color="white"
            visible='false'
            text="anchor: align; align: left; baseline: top"
            >
      </a-text>


      <a-button id="alfa1" position="-5 1.1 4.5" rotation="0 90 0" button="name: 30grados; value: 30属; color: #f8faff; buttonColor: #858787"></a-button>
      <a-button id="alfa3" position="-5 1.1 2.5" rotation="0 90 0" button="name: 60grados; value: 60属; color: #f8faff; buttonColor: #858787"></a-button>
      <a-button id="alfa2" position="-5 1.1 3.5" rotation="0 90 0" button="name: 45grados; value: 45属; color: #f8faff; buttonColor: #858787"></a-button>
      <!-- /Pizarra -->
    </a-scene>
	</body>
		<script type="text/javascript">
			pay = {
				student_id: 301,
				experience_id: 2,
				slug: 'inicio',
				value: true,
				//value_num: algun numero
			}
			send2api(pay)

			var webpage = "http://192.168.0.24:8000/api/metric/post/";
			function send2api(payload){
				var data = new FormData();
				data.append( 'json', JSON.stringify( payload ) );
				fetch("http://192.168.0.24:8000/api/metric/post/",
				//fetch("http://localhost:8000/api/metric/post/",
				{
						method: "POST",
						body: data
				})
				.then(function(res){ return res.json(); })
				.then(function(data){ console.log("metric sent") })
			}
		</script>
		<script type="text/javascript">

/*************************
				VARIABLES
*************************/

// Valores posibles de seleccion
//var velocidades = [18, 12, 6] //velocidades iniciales disponibles
var velocidades = [18] //velocidades iniciales disponibles
var angulos = [30,45,60] //angulos disponibles
var angulos_h = [-1,0,1] //angulos disponibles
var respuestas = []
var cant_respuestas = 8

// para click en cannon
var v_o = 18;
var cannon_angle = 0; // angulo horizontal
var gamma = 30; // angulo vertical

var distanciaTarget;
var yTarget=0;
var xTarget=0;
var gravity = 9.8;
var launching_ball = false; //true: bola es lanzada

var video = document.querySelector("#tutorial");
var playTV = document.querySelector("#playTV");
var indicadorcoordenadas = document.querySelector('#indicadorcoordenadas');
var alfa1= document.querySelector("#alfa1");
var alfa2= document.querySelector("#alfa2");
var alfa3= document.querySelector("#alfa3");
var textoPizarraEnBlanco = document.querySelector('#textoPizarraEnBlanco');
var textoPizarra30grados = document.querySelector("#textoPizarra30grados");
var textoPizarra45grados = document.querySelector("#textoPizarra45grados");
var textoPizarra60grados = document.querySelector("#textoPizarra60grados");

var offset_z = 4; //offset de calculos de targets respecto a punto de lanzamiento
var offset_y = 0;
var target0 = document.querySelector('#target0');
var orange = document.querySelector('#orange');
var shoot = document.querySelector(".cannon");

var cannonL1 = document.querySelector("#cannonL1");
var cannonL2 = document.querySelector("#cannonL2");
var cannonL3 = document.querySelector("#cannonL3");
var cannon1 = document.querySelector("#cannon1");
var cannon2 = document.querySelector("#cannon2");
var cannon3 = document.querySelector("#cannon3");
var cannons = document.querySelector("#cannons");
var start = document.querySelector('#start');

//Botones para posicion horizontal de ca単on
var angle_1 = document.querySelector('#v1');
var angle0 = document.querySelector('#v2');
var angle1 = document.querySelector('#v3');

// Tutorial - Tooltips
class Hint {
	constructor() {
		this.btn_tooltips = document.querySelector('#btn_tooltips');
		this.hint_rectangle = document.querySelector("#hint_rectangle");
		this.dom = document.querySelector("#hints");
		this.active = false;
		this.step = 0;
		//this.change_angle = 0;
		//this.change_position = 0;
		this.changeHintText("Hola, bienvenido a la experiencia N属2 de umVRal. Para comenzar, aprieta el bot坦n 'empezar'.");
	}
	reset() {
		this.active = false;
		this.change_temp = 0;
	}
	changeHintText(text) {
		this.dom.setAttribute('text', {'value': text}) 
	}
	change_funct() {
		let that = this;
		if((that.change_temp < 2) && that.active) { that.change_temp++; }
		else {
			that.changeHintText('Bien!. Continua experimentando en la experiencia, y aprende con nostoros! LH.', that.dom);
			that.fade_out();
		}
	}
	start(){
		let that = this;
		if (that.step === 1){
			that.changeHintText("Bien!. Ahora, prueba cambiando la posici坦n del ca単on en el panel a tu derecha.");
			that.step++;
		}
	}
	change_position() {
		let that = this;
		if (that.step === 2){
			that.changeHintText('Prueba ahora cambiando el angulo del ca単on');
			this.step++;
		}
	}
	change_angle() {
		let that = this;
		if (that.step === 3){
			that.changeHintText('Bien!. Ahora llego la hora de lanzar proyectil. Ajusta coordenadas de ca単on, y miralo para lanzar proyectil.');
			that.step++;
		}
	}
	launch() {
		let that = this;
		if (that.step === 4){
			that.changeHintText('Bien!. Ahora llego la hora de lanzar proyectil. Ajusta coordenadas de ca単on, y miralo para lanzar proyectil.');
			that.step++;
		}
	}
	target() {
		let that = this;
		if (that.step === 4 || that.step === 5){
			that.changeHintText('Ya tienes tu primer acierto!. Ahora, impacta unos 2 blancos m叩s para poder completar experiencia');
			that.step++;
			setTimeout(function(){ 
				that.hint_rectangle.setAttribute('animation',"property: slice9.opacity; dir: alternate; dur: 1000; easing: easeInSine; loop: false; to: 0");
				that.dom.setAttribute('animation',"property: text.opacity; dir: alternate; dur: 1000; easing: easeInSine; loop: false; to: 0");
				setTimeout(function(){
						that.hint_rectangle.setAttribute('visible', false);
						that.dom.setAttribute('visible', false);
				},1000);
			}, 4000);
		}
	}
	fade_out() {
		let that = this;
		this.active = false;
		setTimeout(function(){ 
			that.hint_rectangle.setAttribute('animation',"property: slice9.opacity; dir: alternate; dur: 1000; easing: easeInSine; loop: false; to: 0");
			that.dom.setAttribute('animation',"property: text.opacity; dir: alternate; dur: 1000; easing: easeInSine; loop: false; to: 0");
		}, 1000);
	};
	fade_in() {
		let that = this;
		that.reset();
		that.active = true;
		that.dom.setAttribute('visible', true);
		setTimeout(function(){ 
			that.hint_rectangle.setAttribute('animation',"property: slice9.opacity; dir: alternate; dur: 1000; easing: easeInSine; loop: false; to: 0.7");
			that.dom.setAttribute('animation',"property: text.opacity; dir: alternate; dur: 1000; easing: easeInSine; loop: false; to: 1");
			that.step++;
		}, 500);
	}
}
hints = new Hint();

var comenzo=false;
//Generar las respuestas de la experiencia
generateAnswers();
nextTarget();


/*************************
	 FUNCIONES DE EVENTOS
**************************/

hints.btn_tooltips.addEventListener('click', function(){
	hints.fade_in();
	pay = {
		student_id: 301,
		experience_id: 2,
		slug: 'tutorial',
		value: true,
		//value_num: algun numero
	}
	send2api(pay);
})

start.addEventListener('click', function(){
	nextTarget();
	//hints.step = 1;
	//TODO : Tengo que ver el problema si el usuario apreta empezar antes,
	// Para saltar el paso
	hints.start();
	comenzo = true;
	target0.setAttribute('visible', 'true');
	start.setAttribute('visible', 'false');
	indicadorcoordenadas.setAttribute('visible','true');
});

cannon1.addEventListener('click', function(){
	orange.setAttribute('material','color: orange; shader: flat');
	cannonL1.setAttribute('visible', 'true');
	cannonL2.setAttribute('visible', 'false');
	cannonL3.setAttribute('visible', 'false');
});
cannon2.addEventListener('click', function(){
	orange.setAttribute('material','color: black; shader: flat');
	cannonL1.setAttribute('visible', 'false');
	cannonL2.setAttribute('visible', 'true');
	cannonL3.setAttribute('visible', 'false');
});
cannon3.addEventListener('click', function(){
	orange.setAttribute('material','color: blue; shader: flat');
	cannonL1.setAttribute('visible', 'false');
	cannonL2.setAttribute('visible', 'false');
	cannonL3.setAttribute('visible', 'true');
});


alfa1.addEventListener('click', function(){
	textoPizarraEnBlanco.setAttribute('visible','false');
	textoPizarra45grados.setAttribute('visible','false');
	textoPizarra60grados.setAttribute('visible','false');
	textoPizarra30grados.setAttribute('visible','true');
	gamma=30;
	// cambio en angulo del ca単on
	cannonL1.object3D.rotation.x = degToRad(90+gamma);
	cannonL2.object3D.rotation.x = degToRad(90+gamma);
	cannonL3.object3D.rotation.x = degToRad(90+gamma);
	// cambio de angulo bala
	if(comenzo){
		document.querySelector("#coordenadastarget").setAttribute('value','coordenadas ( x='+xTarget+'[m] ,y='+yTarget+'[m] ) \n Velocidad disparo= 18[m/s]');
	}

});


alfa2.addEventListener('click', function(){
	textoPizarraEnBlanco.setAttribute('visible','false');
	textoPizarra45grados.setAttribute('visible','true');
	textoPizarra60grados.setAttribute('visible','false');
	textoPizarra30grados.setAttribute('visible','false');
	gamma=45;
	// cambio en angulo del ca単on
	cannonL1.object3D.rotation.x = degToRad(90+gamma);
	cannonL2.object3D.rotation.x = degToRad(90+gamma);
	cannonL3.object3D.rotation.x = degToRad(90+gamma);
	//
	if(comenzo){
		document.querySelector("#coordenadastarget").setAttribute('value','coordenadas ( x='+xTarget+'[m] ,y='+yTarget+'[m] ) \n Velocidad disparo= 18[m/s]');
	}


});
alfa3.addEventListener('click', function(){
	textoPizarraEnBlanco.setAttribute('visible','false');
	textoPizarra45grados.setAttribute('visible','false');
	textoPizarra60grados.setAttribute('visible','true');
	textoPizarra30grados.setAttribute('visible','false');
	gamma=60;
	// cambio en angulo del ca単on
	cannonL1.object3D.rotation.x = degToRad(90+gamma);
	cannonL2.object3D.rotation.x = degToRad(90+gamma);
	cannonL3.object3D.rotation.x = degToRad(90+gamma);
	// cambio de angulo bala
	if(comenzo){
		document.querySelector("#coordenadastarget").setAttribute('value','coordenadas ( x='+xTarget+'[m] ,y='+yTarget+'[m] ) \n Velocidad disparo= 18[m/s]');
	}
});

var alfa1panel= document.querySelector("#h1");
var alfa2panel= document.querySelector("#h2");
var alfa3panel= document.querySelector("#h3");
alfa1panel.addEventListener('click', function(){
	textoPizarraEnBlanco.setAttribute('visible','false');
	textoPizarra45grados.setAttribute('visible','false');
	textoPizarra60grados.setAttribute('visible','false');
	textoPizarra30grados.setAttribute('visible','true');
	gamma=30;
	hints.change_angle();
	// cambio en angulo del ca単on
	cannonL1.object3D.rotation.x = degToRad(90+gamma);
	cannonL2.object3D.rotation.x = degToRad(90+gamma);
	cannonL3.object3D.rotation.x = degToRad(90+gamma);
	// cambio de angulo bala
	if(comenzo){
		document.querySelector("#coordenadastarget").setAttribute('value','coordenadas ( x='+xTarget+'[m] ,y='+yTarget+'[m] ) \n Velocidad disparo= 18[m/s]');
	}

});
alfa2panel.addEventListener('click', function(){
	textoPizarraEnBlanco.setAttribute('visible','false');
	textoPizarra45grados.setAttribute('visible','true');
	textoPizarra60grados.setAttribute('visible','false');
	textoPizarra30grados.setAttribute('visible','false');
	gamma=45;
	hints.change_angle();
	// cambio en angulo del ca単on
	cannonL1.object3D.rotation.x = degToRad(90+gamma);
	cannonL2.object3D.rotation.x = degToRad(90+gamma);
	cannonL3.object3D.rotation.x = degToRad(90+gamma);
	// cambio de angulo bala
	if(comenzo){
		document.querySelector("#coordenadastarget").setAttribute('value','coordenadas ( x='+xTarget+'[m] ,y='+yTarget+'[m] ) \n Velocidad disparo= 18[m/s]');
	}

});
alfa3panel.addEventListener('click', function(){
	textoPizarraEnBlanco.setAttribute('visible','false');
	textoPizarra45grados.setAttribute('visible','false');
	textoPizarra60grados.setAttribute('visible','true');
	textoPizarra30grados.setAttribute('visible','false');
	gamma=60;
	hints.change_angle();
	// cambio en angulo del ca単on
	cannonL1.object3D.rotation.x = degToRad(90+gamma);
	cannonL2.object3D.rotation.x = degToRad(90+gamma);
	cannonL3.object3D.rotation.x = degToRad(90+gamma);
	// cambio de angulo bala
	if(comenzo){
		document.querySelector("#coordenadastarget").setAttribute('value','coordenadas ( x='+xTarget+'[m] ,y='+yTarget+'[m] ) \n Velocidad disparo= 18[m/s]');
	}

});


playTV.addEventListener('click',function(){
	video.play();
	playTV.setAttribute('visible','false');
});

video.addEventListener('ended',myHandler,false);
function myHandler(e) {
		playTV.setAttribute('visible','true');
}


/* Lanzamiento de Bala */
cannons.addEventListener('click', function(){
	if (launching_ball === false || orange.body.position < -1 || orange.body.position.y < 0.8) {
		launching_ball = true;
		hints.launch();
		pay = {
			student_id: 301,
			experience_id: 2,
			slug: 'disparo',
			value: true,
			//value_num: algun numero
		}
		send2api(pay);
		//Reset de velocidades de la Bala
		orange.body.angularVelocity.set(0,0,0);
		orange.body.quaternion.set(0,0,0,1);
		orange.body.position.set(0, 1.5, -4.5);
		velocity = getVelocity(v_o , gamma, cannon_angle)
		orange.body.velocity.set(velocity[0], velocity[1], -velocity[2]);
	}
});

shoot.addEventListener('click', function(){

	if (launching_ball === false || orange.body.position < -1 || orange.body.position.y < 0.8) {
		launching_ball = true;
		//Reset de velocidades de la Bala
		hints.launch();
		pay = {
			student_id: 301,
			experience_id: 2,
			slug: 'disparo',
			value: true,
			//value_num: algun numero
		}
		send2api(pay);
		orange.body.angularVelocity.set(0,0,0);
		orange.body.quaternion.set(0,0,0,1);
		orange.body.position.set(0, 1.5, -4.5);
		velocity = getVelocity(v_o , gamma, cannon_angle)
		orange.body.velocity.set(velocity[0], velocity[1], -velocity[2]);
	}
});


/* Evento de colision de Raycaster de Bala con Target/Plano */
/* Funcion que se lanza, cuando la bala tiene una colision con un
	target o el suelo, para poder reiniciar el disparo
	* Variables Offset: sirven cuando el ca単on tinee que moverse de posicion, ya
	que se asume que el ca単on debiese estar en 0.0
	*/
orange.addEventListener('raycaster-intersection', function (e) {
	launching_ball = false;
	if (e.detail.els[0].getAttribute('id') === 'plano'){
		orange.body.velocity.set(0, 0, 0);
		orange.body.position.set(0, -4, -4.5);
	}
	else if (e.detail.els[0].getAttribute('id') === 'target0'){
		hints.target();
		pay = {
			student_id: 301,
			experience_id: 2,
			slug: 'acierto',
			value: true,
			//value_num: algun numero
		}
		send2api(pay)
		orange.body.velocity.set(0, 0, 0);
		orange.body.position.set(0, -4, -4.5);
		nextTarget();
	}
	// OJO: Este if, fija la respuesta para cierto angulo. Si el target tiene dos respuestas,
	// entonces no funcionaria, y habria que hacer colisiones con dos versiones
	/*
	if (parseInt(e.detail.els[0].getAttribute('angle')) == gamma){
	}
	*/
});


/* Click, para cambiar el ca単on de posicion horizontal */
angle_1.addEventListener('click', function(){
	changeCanonPosition(-1);
});
angle0.addEventListener('click', function(){
	changeCanonPosition(0);
});
angle1.addEventListener('click', function(){
	changeCanonPosition(1);
});

/**************************
	 FUNCIONES DE SOPORTE
**************************/

// Crear posicion no random para los targets
/*
	* angle : Angulo horizontal
	* v_o : Velocidad inicial del arreglo
	* gamma : Angulo vertical del ca単on
	*/
function targetPos(angle, v_o, gamma){
	if (angle === -1) {
		position = getTargetPosition(v_o, gamma, -1) //Obtener posicion random para el target
		target0.object3D.position.set(position[0],position[1]+offset_y,-(position[2]+offset_z));
		target0.object3D.rotation.y = degToRad(20);

	}
	else if (angle === 1){
		position = getTargetPosition(v_o, gamma, 1) //Obtener posicion random para el target
		target0.object3D.position.set(position[0],position[1]+offset_y,-(position[2]+offset_z));
		target0.object3D.rotation.y = degToRad(-20);
	}
	else {
		position = getTargetPosition(v_o, gamma, 0) //Obtener posicion random para el target
		target0.object3D.position.set(0,position[1]+offset_y,-(position[2]+offset_z));
		target0.object3D.rotation.y = degToRad(0);
	}
}


/* generateAnswers*/
/* Genera las respuestas al inicio de la experiencia, que el estudiante
	tiene que responder para poder completar la experiencia
	- formato respuesta: [velocidad, angulo_vert, angulo_hor]*/
function generateAnswers(){
	for(i=0; i<cant_respuestas; i++){
		var aux = {};
		aux.vel = velocidades[getRandNumber(velocidades.length)];
		aux.vertangl = angulos[getRandNumber(angulos.length)];
		aux.horangl = angulos_h[getRandNumber(angulos_h.length)];
		respuestas.push(aux);
	}
}

/* nextTarget */
/* Saca de la pila de targets a ser apuntados el pr坦ximo target */
function nextTarget(){
	if(respuestas.length >= 1){
		let t = respuestas.pop();
		targetPos(t.horangl, t.vel, t.vertangl);
	}
	else {
		target0.setAttribute("visible",false);
		indicadorcoordenadas.setAttribute('value','Experiencia Finalizada!');
	}
	return true;
}

/* getRandNumber*/
/* Devuelve un numero random, de 0 a limit */
function getRandNumber(limit){
	return Math.floor(Math.random()*limit);
}

/* Obtener velocidad de la Bala, en el lanzamiento */
function getVelocity(v_o, theta, angulo) {
	theta = degToRad(theta)
	v_x = 0
	v_z = v_o * Math.cos(theta)
	if (angulo === +1){
		v_x = v_z * Math.cos(70)
		v_z = v_z * Math.sin(70)
	}
	else if (angulo === -1){
		v_x = -v_z * Math.cos(70)
		v_z = v_z * Math.sin(70)
	}
	v_y = v_o * Math.sin(theta)
	return [v_x, v_y, v_z]
}

/* Obtener posici坦n pr坦xima de un Target */
/*
Obtiene posicion random de un target
input:
v_o: Veloicdad inicial correcta
theta: Angulo correcto de respuesta
grad: Grado Horizontal
*/
function getTargetPosition(v_o, theta, grad) {
	theta = degToRad(theta)
	v_y = v_o * Math.sin(theta);
	v_x = v_o * Math.cos(theta);
	time_max = (2 * v_y)/gravity;
	interval = (time_max - 0.3 )/ 7;
	//Se a単ade un tiempo peque単o, para que target no aparesca en el mismo lugar
	//que el ca単on
	rand = Math.floor(Math.random()*8)
	time = (rand*interval)+0.3;
	p_y = (v_y * time) - 0.5*gravity*Math.pow(time, 2);
	p_x = 0;
	p_z = v_x * time;

	if (grad === -1){
		p_x = (-p_z * Math.cos(70));
		p_z = (p_z * Math.sin(70));
	}
	else if (grad === 1){
		p_x = (p_z * Math.cos(70));
		p_z = (p_z * Math.sin(70));
	}
	yTarget=Math.floor((p_y+1)*100)/100;
	xTarget=Math.floor(Math.sqrt(p_x*p_x + p_z*p_z)*100)/100;

	indicadorcoordenadas.setAttribute('value','( '+xTarget+'[m] , '+yTarget+'[m] )');


	return [p_x, p_y+1, p_z];
}

/* Cambiar Grados por Radianes. Requerida por THREE.JS */
function degToRad(deg){
	return deg * Math.PI / 180;
}

grad20 = degToRad(20);
function changeCanonPosition(angle) {
		hints.change_position();
		if (angle === -1){
			cannonL1.object3D.rotation.y = grad20;
			cannonL2.object3D.rotation.y = grad20;
			cannonL3.object3D.rotation.y = grad20;
			cannon_angle = -1;
		}
		else if (angle === 1){
			cannonL1.object3D.rotation.y = -grad20;
			cannonL2.object3D.rotation.y = -grad20;
			cannonL3.object3D.rotation.y = -grad20;
			cannon_angle = 1;
		}
		else{
			cannonL1.object3D.rotation.y = 0;
			cannonL2.object3D.rotation.y = 0;
			cannonL3.object3D.rotation.y = 0;
			cannon_angle = 0;
		}
}
		</script>
	<!--script type="text/javascript" src="assets/exp2/js/exp2.js"></script-->
</html>
