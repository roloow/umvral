<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>umVRal - Caida Libre</title>
    <meta name="description" content="Experiencia VR de caida libre">
    <script src="assets/javascripts/aframe.min.js"></script>
    <script src="assets/javascripts/aframe-mouse-cursor-component.min.js"></script>
		<script src="assets/javascripts/aframe-physics-system.min.js"></script>
    <script src="assets/javascripts/aframe-material.min.js"></script>
    <script src="assets/javascripts/aframe-extras.min.js"></script>
    <script src="assets/javascripts/moment-with-locales.js"></script>
    <script src="assets/javascripts/aframe-environment-component.min.js"></script>
    <script type="text/javascript">
      $ = (sel) => document.querySelector(sel)
      $$ = (sel) => document.querySelectorAll(sel)
      on = (elem, type, hand) => elem.addEventListener(type,hand)
    </script>
    <script type="text/javascript">
      AFRAME.ASSETS_PATH = "./assets";
    </script>
  </head>
	<body>

    <a-scene id="source" cursor="rayOrigin: mouse" physics="driver: local; iterations: 100;">
      <a-assets>
        <a-mixin id="image" geometry="height: 2; width: 2"></a-mixin>
      </a-assets>
      <!-- Inicio de Controles -->
      <a-entity id="camWrapper" position="0 1 3" rotation="0 +20 0">
        <a-entity id="cam" camera look-controls wasd-controls>
          <a-entity id="selector" cursor="fuse: true; fuseTimeout: 1000"
              position="0 0 -1"
              geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
              material="color: black; shader: flat">
              <a-animation begin="click" easing="ease-in" attribute="scale" dur="150" fill="forwards" from="0.1 0.1 0.1" to="1 1 1"></a-animation>
              <a-animation begin="cursor-fusing" easing="ease-in" attribute="scale" dur="1000" fill="backwards" from="1 1 1" to="0.1 0.1 0.1"></a-animation>
            </a-entity>
        </a-entity>
      </a-entity>
      <!-- Fin de Controles -->
      <!-- Environment -->
      <a-entity id="env" environment="active: true; preset: egypt; skyType: atmosphere; ground: hills; playArea: 1.2; dressingAmount: 3; fog: 0.5;"></a-entity>
      <!-- Cilindro, para poder probar posiciones en el telefono, de posiciones de objetos -->
      <!--a-cylinder static-body position="0 0 1" radius="6" height="0.2"  color="blue"></a-cylinder-->
      <!-- /Environment -->

      <!-- ESCENA -->
      <!-- Bola de cañon -->
			<a-entity id="orange"
								dynamic-body
								geometry="primitive: sphere; radius: 0.2"
								material="color: orange; shader: flat"
								raycaster="showLine: true; objects: .blanco; useWorldCoordinates: false; origin: 0, 0, 0; direction: 1, 0, -1"
								position="0 0 -4">
			</a-entity>
      <!-- /Bola de cañon -->


      <!-- Tele OBJ-->
      <a-assets>
        <a-asset-item id="tele-obj" src="/objetos/tele.obj"></a-asset-item>
        <a-asset-item id="tele-mtl" src="/objetos/tele.mtl"></a-asset-item>
      </a-assets>
      <a-entity obj-model="obj: #tele-obj; mtl: #tele-mtl" scale="0.025 0.025 0.025" position="-0.7 0 7.5" rotation="270 0 180"></a-entity>
      <!-- /Tele OBJ-->

      <a-assets>
          <video id="tutorial" autoplay="true" loop="true" src="video/prueba480.mp4"></video>
      </a-assets>
      <a-video src="#tutorial" width="1.6" height="0.9" position="-0.20 1.5 6" material="" geometry="" rotation="0 180 0" scale="1 1 1"></a-video>
      <!-- Cañon -->
      <a-cylinder id="cannon" class="cannon" position="0 0 -4" radius="0.4" height="5" rotation="-45 0 0" color="gray"></a-cylinder>
      <a-box position="3 0.3 -3" height="0.8" width="4" rotation="0 -20 0" color="brown"></a-box>

        <a-button id="v1" position="1 0.3 -3" rotation="0 -20 0" name="velocidad1"  value="1"></a-button>
        <a-button id="v2" position="2 0.3 -2.5" rotation="0 -20 0" name="velocidad2"  value="2"></a-button>
        <a-button id="v3" position="3 0.3 -2" rotation="0 -20 0" name="velocidad3"  value="3"></a-button>
      <!-- /Cañon -->

      <!-- rack -->
      <a-assets>
        <a-asset-item id="rack-obj" src="/objetos/rack.obj"></a-asset-item>
        <a-asset-item id="rack-mtl" src="/objetos/rack.mtl"></a-asset-item>
      </a-assets>
      <a-entity obj-model="obj: #rack-obj; mtl: #rack-mtl" scale="0.01 0.01 0.01" rotation="-90 -45 0" position="7 0 6"></a-entity>
      <!-- /rack -->

      <!-- Cañones a seleccionar -->
      <a-assets>
        <a-asset-item id="cannon1-obj" src="/objetos/canongris.obj"></a-asset-item>
        <a-asset-item id="cannon1-mtl" src="/objetos/canongris.mtl"></a-asset-item>
        <a-asset-item id="cannon2-obj" src="/objetos/canonmadera.obj"></a-asset-item>
        <a-asset-item id="cannon2-mtl" src="/objetos/canonmadera.mtl"></a-asset-item>
        <a-asset-item id="cannon3-obj" src="/objetos/canonjade.obj"></a-asset-item>
        <a-asset-item id="cannon3-mtl" src="/objetos/canonjade.mtl"></a-asset-item>
      </a-assets>
      <a-entity obj-model="obj: #cannon3-obj; mtl: #cannon3-mtl" scale="0.0008 0.0008 0.0008" rotation="90 -15 0" position="7 3.4 6"></a-entity>
      <a-entity obj-model="obj: #cannon2-obj; mtl: #cannon2-mtl" scale="0.0008 0.0008 0.0008" rotation="90 -15 0" position="7 2 6"></a-entity>
      <a-entity obj-model="obj: #cannon1-obj; mtl: #cannon1-mtl" scale="0.008 0.008 0.008" rotation="90 -35 0" position="7 4 6"></a-entity>

      <!-- /Cañones a seleccionar -->

      <!-- Plano   -->
      <a-plane static-body position="0 -0.01 -4" rotation="-90 0 0" width="100" height="100" color="#7BC8A4" shadow></a-plane>
      <!-- /Plano -->

      <!-- Blanco -->
				<a-cylinder id="target1" class="blanco" src="assets/exp2/targettexture.jpg" position="0 3 -24" radius="0.8" height="0.1" rotation="90 0 0"
				></a-cylinder>
      <!-- /Blanco -->

      <!-- Pizarra OBJ-->
      <a-assets>
        <a-asset-item id="piz-obj" src="/objetos/pizarra.obj"></a-asset-item>
        <a-asset-item id="piz-mtl" src="/objetos/pizarra.mtl"></a-asset-item>
      </a-assets>
      <a-entity obj-model="obj: #piz-obj; mtl: #piz-mtl" scale="0.015 0.015 0.015" position="-5.05 0 3" rotation="-90 90 0"></a-entity>

      <!-- /Pizarra OBJ-->

      <!-- Pizarra >
      <a-plane id="pizarra" width="4" height= "3" rotation="0 90 0" position="-5 3 3" color= "white" ></a-plane-->
      <a-text id="textoPizarraEnBlanco"
              value=" x(t)= vt + x0 \n "
              width="4"
              height = "3"
              position="-5 3.5 4.95"
              rotation="0 90 0"
              color="white"
              text="anchor: align; align: left; baseline: top"
              >
      </a-text>

      <a-text id="textoPizarra30grados"
            value=" x(t)= vt(set(30)) + x0 \n y(t)= -g(t^2)/2 + vt(cos(30)) + y0 \n sen(30)= \n cos(30)= "
            height = "3"
            width="4"
            position="-5 3.5 4.95"
            rotation="0 90 0"
            color="white"
            visible='false'
            text="anchor: align; align: left; baseline: top"
            >
      </a-text>

      <a-text id="textoPizarra45grados"
            value=" x(t)= vt(set(45)) + x0 \n y(t)= -g(t^2)/2 + vt(cos(45)) + y0 \n sen(45)= \n cos(45)= "
            height = "3"
            width="4"
            position="-5 3.5 4.95"
            rotation="0 90 0"
            color="white"
            visible='false'
            text="anchor: align; align: left; baseline: top"
            >
      </a-text>

      <a-text id="textoPizarra60grados"
            value=" x(t)= vt(set(60)) + x0 \n y(t)= -g(t^2)/2 + vt(cos(60)) + y0 \n sen(60)= \n cos(60)= "
            height = "3"
            width="4"
            position="-5 3.5 4.95"
            rotation="0 90 0"
            color="white"
            visible='false'
            text="anchor: align; align: left; baseline: top"
            >
      </a-text>


      <a-button id="alfa1" position="-5 1.1 4.5" rotation="0 90 0" button="name: 30grados; value: 30º; color: #f8faff; buttonColor: #858787"></a-button>
      <a-button id="alfa3" position="-5 1.1 2.5" rotation="0 90 0" button="name: 60grados; value: 60º; color: #f8faff; buttonColor: #858787"></a-button>
      <a-button id="alfa2" position="-5 1.1 3.5" rotation="0 90 0" button="name: 45grados; value: 45º; color: #f8faff; buttonColor: #858787"></a-button>
      <!-- /Pizarra -->



    </a-scene>
	</body>
  <script>
   /*
    window.addEventListener('click', function () {
      // METHOD1 - ADD A NEW ORANGE TO SCENE - not working
      // const orange =
      // `<a-entity class="orange" dynamic-body velocity="0 0 -10" geometry="primitive: sphere; radius: 0.1" position="0 2 -2" material="src: #orangesrc; roughness: 0.48; color: #edaa45;" shadow="cast:true;receive:true"></a-entity>`
      // var el = document.createElement('a-entity');
      // AFRAME.scenes[0].appendChild(el);
      // el.innerHTML = orange;
      // el.setAttribute('dynamic-body');

      // METHOD2 - MOVE THE EXISTING ORANGE
      document.querySelector("#orange").body.position.set(0, 1.5, -0.5);
      document.querySelector("#orange").body.velocity.set(0, 6, -20);
      //document.querySelector("#gun").components.sound.playSound();
    }); */

    // para click en cannon
    var v_o = 18;
    var theta = 25; // angulo horizontal
    var gama = 30; // angulo vertical
    var gravity = 9.8;

    var alfa1= document.querySelector("#alfa1");
    var alfa2= document.querySelector("#alfa2");
    var alfa3= document.querySelector("#alfa3");
    var textoPizarraEnBlanco = document.querySelector('#textoPizarraEnBlanco');
    var textoPizarra30grados = document.querySelector("#textoPizarra30grados");
    var textoPizarra45grados = document.querySelector("#textoPizarra45grados");
    var textoPizarra60grados = document.querySelector("#textoPizarra60grados");

    /***********************/
    /* FUNCIONES DE EVENTOS */
    /***********************/

    alfa1.addEventListener('click', function(){
      textoPizarraEnBlanco.setAttribute('visible','false');
      textoPizarra45grados.setAttribute('visible','false');
      textoPizarra60grados.setAttribute('visible','false');
      textoPizarra30grados.setAttribute('visible','true');
      gama=30;
    });
    alfa2.addEventListener('click', function(){
      textoPizarraEnBlanco.setAttribute('visible','false');
      textoPizarra45grados.setAttribute('visible','true');
      textoPizarra60grados.setAttribute('visible','false');
      textoPizarra30grados.setAttribute('visible','false');
      gama=45;
    });
    alfa3.addEventListener('click', function(){
      textoPizarraEnBlanco.setAttribute('visible','false');
      textoPizarra45grados.setAttribute('visible','false');
      textoPizarra60grados.setAttribute('visible','true');
      textoPizarra30grados.setAttribute('visible','false');
      gama=60;
    });


    /* Lanzamiento de Bala */
    var cannon_ = document.querySelector(".cannon");
    cannon_.addEventListener('click', function(){
      console.log('gama : '+ gama);
      //document.querySelector("#orange").body.position.set(0, 1.5, -0.5);
      document.querySelector("#orange").body.position.set(0, 1.5, -4.5);
      velocity = getVelocity(v_o , theta, 0)
      document.querySelector("#orange").body.velocity.set(velocity[2], velocity[1], -velocity[0]);
    });

    /* Funcion que se lanza, cuando la bala tiene una colision con un
      target, para poder reiniciar el disparo
      */
    offset_x = 4
    offset_y = 0
		target1 = document.querySelector('#target1');
    orange = document.querySelector('#orange')
		orange.addEventListener('raycaster-intersection', function (e) {
      position = getTargetPosition(v_o, theta)
			console.log('Target logrado!');
      console.log(position)
      orange.setAttribute('visible','true');
      target1.object3D.position.set(0,position[1]+offset_y,-(position[0]+offset_x));
      //document.querySelector("#orange").body.position.set(0, 1.5, -4.5);
      document.querySelector("#orange").body.velocity.set(0, 0, 0);
      document.querySelector("#orange").body.position.set(0, 0, -4.5);
		});


    /***********************/
    /* FUNCIONES DE SOPORTE */
    /***********************/

    function getVelocity(v_o, theta, angulo) {
      theta = (theta * Math.PI / 180)
      v_x = v_o * Math.cos(theta)
      v_z = 0
      angulo_x_z = (70 * Math.PI / 180)
      if (angulo === +1){
        v_x = v_x * Math.sin(angulo_x_z)
        v_z = v_x * Math.cos(angulo_x_z)
      }
      else if (angulo === -1){
        v_x = v_x * Math.sin(angulo_x_z)
        v_z = - v_x * Math.cos(angulo_x_z)
      }
      v_y = v_o * Math.sin(theta)
      return [v_x, v_y, v_z]
    }

    /* Obtiene posicion del target
    input:
    v_o: Veloicdad inicial correcta
    theta: Angulo correcto de respuesta*/
    function getTargetPosition(v_o, theta) {
      theta = (theta * Math.PI / 180)
      v_y = v_o * Math.sin(theta);
      v_x = v_o * Math.cos(theta);
      time_max = (2 * v_y)/gravity;
      time = (Math.random() * time_max);
      console.log(time)
      console.log("max time")
      console.log(time_max)
      p_y = (v_y * time) - 0.5*gravity*Math.pow(time, 2);
      p_x = v_x * time;
      return [p_x, p_y+1];
    }
		angle_1 = document.querySelector('#v1');
		angle0 = document.querySelector('#v2');
		angle1 = document.querySelector('#v3');

    angle_1.addEventListener('click', function(){
        changeCanonPosition(-1);
    });
    angle0.addEventListener('click', function(){
        changeCanonPosition(0);
    });
    angle1.addEventListener('click', function(){
        changeCanonPosition(1);
    });

    //Funcion que hacer girar al cañon sin parar
		cannon_obj = document.querySelector('#cannon');
    grad20 = (20 * Math.PI / 180)
    function changeCanonPosition(angle) {
        if (angle === -1){
          cannon_obj.object3D.rotation.y = grad20;
        }
        else if (angle === 1){
          cannon_obj.object3D.rotation.y = -grad20;
        }
        else{
          cannon_obj.object3D.rotation.y = 0;
        }

      /*
      clearInterval();
      window.setInterval(function(){
        cannon_obj.object3D.rotation.y += 0.1;
        console.log(cannon_obj.object3D.rotation.y);

        if (angle === -1){
          position = (cannon_obj.object3D.rotation.y <= -20);
        }
        else if (angle === 1){
          position = (cannon_obj.object3D.rotation.y >= 20);
        }
        else{
          position = (cannon_obj.object3D.rotation.y > -0.2 || cannon_obj.object3D.rotation.y < 0.2);
        }

        if(position){
          clearInterval();
        }
      }, 100);
      clearInterval();
      */
    }

  </script>
</html>
